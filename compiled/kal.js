(function(){function compile(code,options){var token_rv,raw_tokens,comments,tokens,root_node;code=(""+code).trim(),null==options&&(options={bare:!1});try{return options.literate&&(code=literate.translate(code)),token_rv=lexer.tokenize(code),raw_tokens=token_rv[0],comments=token_rv[1],tokens=sugar.translate_sugar(raw_tokens,options,lexer.tokenize),root_node=parser.parse(tokens,comments,options),root_node.js(options)}catch(compile_error){throw compile_error.message||compile_error}}function kal_eval(code,options){var js,vm,sandbox;return null==options&&(options={}),js=compile(code,options),options.show_js?console.log(js):void 0,vm=require("vm"),sandbox=options.sandbox?options.sandbox===!0?exports.makeSandbox(options):options.sandbox:global,sandbox===global?(null==sandbox.module&&null==sandbox.require&&(sandbox=exports.makeSandbox(sandbox,options)),vm.runInThisContext(js)):vm.runInContext(js,sandbox)}function makeSandbox(sandbox,options){var vm,path,new_sandbox,k,kobj$1,Module,_module,_require,r,ki$2,kobj$2;if(vm=require("vm"),path=require("path"),null==sandbox)sandbox=vm.createContext(global);else if(!(sandbox instanceof vm.Script.createContext().constructor)&&sandbox!==global){new_sandbox=vm.createContext(global),kobj$1=sandbox;for(k in kobj$1)kobj$1.hasOwnProperty(k)&&(new_sandbox[k]=sandbox[k]);sandbox=new_sandbox}for(sandbox.__filename=(null!=options?options.filename:void 0)||"eval",sandbox.__dirname=path.dirname(sandbox.__filename),Module=require("module"),_module=new Module((null!=options?options.modulename:void 0)||"eval"),sandbox.module=_module,_require=function(path){return Module._load(path,_module,!0)},sandbox.require=_require,_module.filename=sandbox.__filename,kobj$2=Object.getOwnPropertyNames(require),ki$2=0;kobj$2.length>ki$2;ki$2++)r=kobj$2[ki$2],"paths"!==r&&(_require[r]=require[r]);return _module.paths=Module._nodeModulePaths(process.cwd()),_require.paths=_module.paths,_require.resolve=function(request){return Module._resolveFilename(request,_module)},sandbox}var literate,lexer,sugar,parser,generator,extension,k$indexof=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};literate=require("./literate"),lexer=require("./lexer"),sugar=require("./sugar"),parser=require("./parser"),generator=require("./generator");try{exports.VERSION=require("../package.json").version}catch(k$e){exports.VERSION="UNKNOWN"}exports.compile=compile,exports.eval=kal_eval,exports.makeSandbox=makeSandbox,require.extensions&&(extension=function(module,filename){var is_literate,content;is_literate=k$indexof.call([".litkal",".md"],require("path").extname(filename))>=0,content=compile(require("fs").readFileSync(filename,"utf8"),{filename:filename,literate:is_literate}),module._compile(content,filename)},require.extensions[".kal"]=extension,require.extensions[".litkal"]=extension,null==require.extensions[".md"]&&(require.extensions[".md"]=extension))})();