(function(){function translate_sugar(tokens,options,tokenizer){var out_tokens,debug,t,ki$1,kobj$1;if(out_tokens=coffee_style_functions(print_statement(noparen_function_calls(multiline_statements(multiline_lists(clean(code_in_strings(tokens,tokenizer))))))),null!=options?options.show_tokens:void 0){for(debug=[],kobj$1=out_tokens,ki$1=0;kobj$1.length>ki$1;ki$1++)t=kobj$1[ki$1],"NEWLINE"===t.type?debug.push("\n"):debug.push(t.value||t.type);console.log(debug.join(" "))}return out_tokens}function code_in_strings(tokens,tokenizer){var out_tokens,token,rv,r,m,add_parens,new_token_text,new_tokens,ki$2,kobj$2;if(null==tokenizer)return tokens;for(out_tokens=[],kobj$2=tokens,ki$2=0;kobj$2.length>ki$2;ki$2++)if(token=kobj$2[ki$2],k$indexof.call(["STRING","BLOCKSTRING"],token.type)>=0&&'"'===token.value[0]){for(rv=token.value,r=/#{.*?}/g,m=r.exec(rv),add_parens=m?!0:!1,add_parens?out_tokens.push({text:"(",line:token.line,value:"(",type:"LITERAL",soft:!0}):void 0;m;)new_token_text=rv.slice(0,m.index)+'"',out_tokens.push({text:new_token_text,line:token.line,value:new_token_text,type:"STRING"}),out_tokens.push({text:"+",line:token.line,value:"+",type:"LITERAL"}),new_tokens=tokenizer(rv.slice(m.index+2,m.index+m[0].length-1))[0],1!==new_tokens.length?out_tokens.push({text:"(",line:token.line,value:"(",type:"LITERAL"}):void 0,out_tokens=out_tokens.concat(new_tokens),1!==new_tokens.length?out_tokens.push({text:")",line:token.line,value:")",type:"LITERAL"}):void 0,rv='"'+rv.slice(m.index+m[0].length),'""'===rv?rv="":out_tokens.push({text:"+",line:token.line,value:"+",type:"LITERAL"}),r=/#{.*?}/g,m=r.exec(rv);""!==rv?out_tokens.push({text:rv,line:token.line,value:rv,type:"STRING"}):void 0,add_parens?out_tokens.push({text:")",line:token.line,value:")",type:"LITERAL",soft:!0}):void 0}else out_tokens.push(token);return out_tokens}function clean(tokens){var out_tokens,token,ki$3,kobj$3;for(out_tokens=[],kobj$3=tokens,ki$3=0;kobj$3.length>ki$3;ki$3++)token=kobj$3[ki$3],"WHITESPACE"!==token.type?out_tokens.push(token):out_tokens.length>0&&(out_tokens[out_tokens.length-1].trailed_by_white=!0);return out_tokens}function multiline_statements(tokens){var out_tokens,last_token,continue_line,reduce_dedent,token,skip_token,ki$4,kobj$4;for(out_tokens=[],last_token=null,continue_line=!1,reduce_dedent=0,kobj$4=tokens,ki$4=0;kobj$4.length>ki$4;ki$4++)token=kobj$4[ki$4],skip_token=!1,k$indexof.call([","],null!=last_token?last_token.value:void 0)>=0&&"NEWLINE"===token.type?(continue_line=!0,skip_token=!0):continue_line&&("INDENT"===token.type?(skip_token=!0,reduce_dedent+=1):"NEWLINE"===token.type?skip_token=!0:"DEDENT"===token.type&&(reduce_dedent>0?(reduce_dedent-=1,skip_token=!0,0===reduce_dedent&&out_tokens.push({text:"\n",line:token.line,value:"",type:"NEWLINE"})):out_tokens.push(last_token))),skip_token?void 0:out_tokens.push(token),last_token=token;return out_tokens}function noparen_function_calls(tokens){function closeout(){var trigger;for(trigger=triggers[triggers.length-1];(null!=trigger?trigger.indentation:void 0)===indentation&&(null!=trigger?trigger.enclosure_depth:void 0)>=enclosure_depth;)out_tokens.push({text:")",line:token.line,value:")",type:"LITERAL"}),triggers.pop(),trigger=triggers[triggers.length-1]}var out_tokens,triggers,enclosure_depth,indentation,declaring_function,token,i,last_token,last_last_token,next_token,add_auto_paren,acceptable_literal,trigger,ki$5,kobj$5;for(out_tokens=[],triggers=[],enclosure_depth=0,indentation=0,declaring_function=!1,kobj$5=tokens,ki$5=0;kobj$5.length>ki$5;ki$5++)if(token=kobj$5[ki$5],i=ki$5,last_token=tokens[i-1],last_last_token=tokens[i-2],next_token=tokens[i+1],add_auto_paren=!0,k$indexof.call(KEYWORDS,null!=last_token?last_token.value:void 0)>=0&&("."===(null!=last_last_token?last_last_token.value:void 0)||k$indexof.call(RVALUE_OK,null!=last_token?last_token.value:void 0)>=0||(add_auto_paren=!1)),"IDENTIFIER"!==(null!=last_token?last_token.type:void 0)&&(k$indexof.call(["]",")"],null!=last_token?last_token.value:void 0)>=0||(add_auto_paren=!1),")"===(null!=last_token?last_token.value:void 0)&&"-"===token.value&&">"===(null!=next_token?next_token.value:void 0)&&(add_auto_paren=!1)),k$indexof.call(NOPAREN_WORDS,token.value)>=0&&(add_auto_paren=!1),"LITERAL"===token.type&&(acceptable_literal=!1,"{"===token.value&&(acceptable_literal=!0),k$indexof.call(["[","("],token.value)>=0&&(null!=last_token?last_token.trailed_by_white:void 0)&&(acceptable_literal=!0),"-"===token.value&&">"===(null!=next_token?next_token.value:void 0)&&(acceptable_literal=!0),acceptable_literal||(add_auto_paren=!1)),k$indexof.call(["function","task","method","class"],null!=last_token?last_token.value:void 0)>=0&&"."!==(null!=last_last_token?last_last_token.value:void 0)&&(declaring_function=!0),"-"===(null!=last_last_token?last_last_token.value:void 0)&&">"===(null!=last_token?last_token.value:void 0)&&(declaring_function=!0),declaring_function&&(add_auto_paren=!1),"("!==token.value||token.soft||(add_auto_paren=!1),k$indexof.call(["left","right"],null!=last_token?last_token.value:void 0)>=0&&"bitwise"===(null!=last_last_token?last_last_token.value:void 0)&&(add_auto_paren=!1),k$indexof.call(["item","items"],null!=last_token?last_token.value:void 0)>=0&&"delete"===(null!=last_last_token?last_last_token.value:void 0)&&(add_auto_paren=!1),trigger=triggers[triggers.length-1],"INDENT"===token.type)indentation+=1,out_tokens.push(token);else if("DEDENT"===token.type)indentation-=1,out_tokens.push(token),closeout();else if(k$indexof.call(["(","{","["],token.value)>=0)add_auto_paren&&(out_tokens.push({text:"(",line:token.line,value:"(",type:"LITERAL"}),triggers.push({enclosure_depth:enclosure_depth,indentation:indentation})),enclosure_depth+=1,out_tokens.push(token);else if(k$indexof.call([")","}","]"],token.value)>=0)enclosure_depth-=1,null!=trigger&&trigger.enclosure_depth>enclosure_depth?closeout():void 0,out_tokens.push(token);else if("NEWLINE"===token.type)declaring_function||closeout(),declaring_function=!1,out_tokens.push(token);else if(k$indexof.call(["if","unless","when","except"],token.value)>=0)closeout(),out_tokens.push(token);else if(add_auto_paren)out_tokens.push({text:"(",line:token.line,value:"(",type:"LITERAL"}),triggers.push({enclosure_depth:enclosure_depth,indentation:indentation}),out_tokens.push(token);else if("EOF"===token.type){for(;triggers.length>0;)out_tokens.push({text:")",line:token.line,value:")",type:"LITERAL"}),triggers.pop();out_tokens.push(token)}else out_tokens.push(token);for(;triggers.length>0;)out_tokens.push({text:")",line:token.line,value:")",type:"LITERAL"}),triggers.pop();return out_tokens}function coffee_style_functions(tokens){var out_tokens,last_token,i,token,new_tokens,t,f_token;for(out_tokens=[],last_token=null,i=0;tokens.length>i;){if(token=tokens[i],"-"===(null!=last_token?last_token.value:void 0)&&">"===(null!=token?token.value:void 0)){if(out_tokens.pop(),new_tokens=[],t=out_tokens.pop(),")"===(null!=t?t.value:void 0)){for(;"("!==(null!=t?t.value:void 0);)new_tokens.unshift(t),t=out_tokens.pop();new_tokens.unshift(t)}else out_tokens.push(t),new_tokens.push({text:"(",line:token.line,value:"(",type:"LITERAL"}),new_tokens.push({text:")",line:token.line,value:")",type:"LITERAL"});f_token={text:"function",line:token.line,value:"function",type:"IDENTIFIER"},new_tokens.unshift(f_token),out_tokens=out_tokens.concat(new_tokens)}else out_tokens.push(token);last_token=token,i+=1}return out_tokens}function multiline_lists(tokens){var out_tokens,list_depth,last_token_was_separator,indent_depths,indent_depth,leftover_indent,token,skip_this_token,token_is_separator,ki$6,kobj$6;for(out_tokens=[],list_depth=0,last_token_was_separator=!1,indent_depths=[],indent_depth=0,leftover_indent=0,kobj$6=tokens,ki$6=0;kobj$6.length>ki$6;ki$6++)token=kobj$6[ki$6],skip_this_token=!1,token_is_separator=k$indexof.call(["NEWLINE","INDENT","DEDENT"],token.type)>=0||","===token.value,"["===token.value||"{"===token.value?(list_depth+=1,indent_depths.push(indent_depth),indent_depth=0):"]"===token.value||"}"===token.value?(list_depth-=1,leftover_indent=indent_depth,indent_depth=indent_depths.pop()):"INDENT"===token.type?(indent_depth+=1,0!==leftover_indent&&(leftover_indent+=1,skip_this_token=!0,0===leftover_indent?out_tokens.push({text:"",line:token.line,value:"\n",type:"NEWLINE"}):void 0)):"DEDENT"===token.type?(indent_depth-=1,0!==leftover_indent&&(leftover_indent-=1,0===leftover_indent?out_tokens.push({text:"",line:token.line,value:"\n",type:"NEWLINE"}):void 0,skip_this_token=!0)):"NEWLINE"===token.type?0!==leftover_indent&&(skip_this_token=!0):leftover_indent=0,list_depth>0?token_is_separator&&!last_token_was_separator?out_tokens.push({text:",",line:token.line,value:",",type:"LITERAL"}):token_is_separator||skip_this_token?void 0:out_tokens.push(token):skip_this_token?void 0:out_tokens.push(token),last_token_was_separator=token_is_separator&&list_depth>0;return out_tokens}function print_statement(tokens){var new_tokens,token,ki$7,kobj$7;for(new_tokens=[],kobj$7=tokens,ki$7=0;kobj$7.length>ki$7;ki$7++)token=kobj$7[ki$7],"print"===token.value&&"IDENTIFIER"===token.type?(new_tokens.push({text:"print",line:token.line,value:"console",type:"IDENTIFIER"}),new_tokens.push({text:"print",line:token.line,value:".",type:"LITERAL"}),new_tokens.push({text:"print",line:token.line,value:"log",type:"IDENTIFIER"})):new_tokens.push(token);return new_tokens}var grammar,KEYWORDS,RVALUE_OK,NOPAREN_WORDS,k$indexof=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};grammar=require("./grammar"),KEYWORDS=grammar.KEYWORDS,RVALUE_OK=grammar.RVALUE_OK,exports.translate_sugar=translate_sugar,NOPAREN_WORDS=["is","otherwise","except","else","doesnt","exist","exists","isnt","inherits","from","and","or","xor","in","when","instanceof","of","nor","if","unless","except","for","with","wait","task","fail","parallel","series","safe","but","bitwise","mod","second","seconds","while","until","at","to","into","as"]})();